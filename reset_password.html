<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reset Password - Honorian AskBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <link rel="icon" href="Don_Honorio_Ventura_State_University_logo.png" type="image/png">
  <style>
    :root {
      --dhvsu-maroon: #800000;
      --dhvsu-gold: #FFD700;
      --dhvsu-light-maroon: #9e1b1b;
      --dhvsu-dark-maroon: #600000;
      --light-maroon: #A52A2A;
      --gray: #f7f7f7;
      --navbar-height: 60px;
      --gradient-start: #800000;
      --gradient-end: #cc9900;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      background: linear-gradient(135deg, #fff 0%, #fffbe6 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .container {
      background: #fff;
      padding: 2.5rem 2.2rem;
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(128,0,0,0.15), 0 1.5px 10px rgba(128,0,0,0.08);
      max-width: 420px;
      width: 100%;
      text-align: center;
      border: 1px solid #f3e3e3;
      animation: fadeIn 0.7s;
      transition: all 0.3s;
      margin: auto;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .container:hover, .container:focus-within {
      box-shadow: 0 15px 40px rgba(128,0,0,0.2), 0 2px 14px rgba(128,0,0,0.12);
      transform: translateY(-3px) scale(1.01);
    }
    
    h2 {
      color: var(--dhvsu-maroon);
      margin-bottom: 1.2rem;
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-bottom: 0.7rem;
      color: #333;
      font-weight: 600;
      text-align: left;
      font-size: 1.05rem;
    }
    .form-group {
      margin-bottom: 1.8rem;
      position: relative;
    }
    input[type="password"] {
      width: 100%;
      padding: 14px 16px;
      border: 1.5px solid #e0e0e0;
      border-radius: 14px;
      font-size: 1.05rem;
      background: #fafafa;
      transition: all 0.3s;
      height: 52px;
      color: #333;
      -webkit-appearance: none;
      appearance: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) inset;
    }
    input[type="password"]:focus {
      outline: none;
      border-color: var(--dhvsu-gold);
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.15);
      background: #fff;
    }
    input[type="password"]::placeholder {
      color: #999;
      font-size: 0.95rem;
    }
    .password-strength-container {
      margin-top: 10px;
      position: relative;
    }
    .password-strength {
      height: 8px;
      border-radius: 4px;
      transition: all 0.3s;
      background-color: #e0e0e0;
      overflow: hidden;
      position: relative;
    }
    .strength-weak {
      background: linear-gradient(90deg, #f44336 0%, #ff7043 100%);
      width: 30%;
    }
    .strength-medium {
      background: linear-gradient(90deg, #ff9800 0%, #ffd54f 100%);
      width: 60%;
    }
    .strength-strong {
      background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
      width: 100%;
    }
    .strength-text {
      font-size: 0.9rem;
      margin-top: 5px;
      color: #555;
      text-align: left;
      font-weight: 500;
    }
    .password-container {
      position: relative;
    }
    .eye-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.7);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      color: #666;
      font-size: 1.2rem;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      min-width: 46px;
      min-height: 46px;
      margin: -12px -8px;
      transition: all 0.2s;
    }
    .eye-icon:hover, .eye-icon:focus {
      background: rgba(255,255,255,0.9);
      color: var(--dhvsu-maroon);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .eye-icon:focus {
      outline: 2px solid var(--dhvsu-gold);
    }
    .eye-icon svg {
      width: 22px;
      height: 22px;
      stroke-width: 2.2;
    }
    .reset-btn {
      background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 14px 0;
      width: 100%;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(128,0,0,0.2);
      -webkit-appearance: none;
      appearance: none;
      height: 54px;
      touch-action: manipulation;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 1px rgba(0,0,0,0.2);
    }
    .reset-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(128,0,0,0.25);
      background: linear-gradient(135deg, var(--dhvsu-light-maroon) 0%, var(--dhvsu-gold) 100%);
    }
    .reset-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(128,0,0,0.15);
    }
    .reset-btn:focus {
      outline: 2px solid #FFD700;
      box-shadow: 0 0 0 3px rgba(255,215,0,0.2);
    }
    
    /* Button ripple effect */
    .reset-btn:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, .5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(100, 100);
        opacity: 0;
      }
    }
    
    .reset-btn:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    
    .message {
      margin-top: 1.2rem;
      font-size: 1.05rem;
      min-height: 1.5em;
      border-radius: 12px;
      padding: 1em 1.2em;
      font-weight: 500;
      display: none;
      animation: slideDown 0.4s ease-out;
      width: 100%;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .success { 
      color: #155724; 
      background: #d4edda; 
      border-left: 4px solid #28a745; 
      display: block; 
    }
    .error { 
      color: #721c24; 
      background: #f8d7da; 
      border-left: 4px solid #dc3545; 
      display: block; 
    }
    .error-message {
      color: #e74c3c;
      font-size: 0.92rem;
      margin-top: 8px;
      display: none;
      font-weight: 500;
      text-align: left;
      padding-left: 2px;
    }
    .back-link { 
      color: var(--dhvsu-maroon); 
      text-decoration: none; 
      font-weight: 600; 
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      border-radius: 50px;
      margin-top: 1.5rem;
      min-height: 44px;
      background-color: rgba(128,0,0,0.05);
    }
    .back-link:hover { 
      text-decoration: none; 
      color: var(--dhvsu-dark-maroon);
      background-color: rgba(128,0,0,0.08);
      transform: translateY(-2px);
    }
    .back-link svg {
      margin-right: 10px;
      transition: transform 0.2s;
    }
    .back-link:hover svg {
      transform: translateX(-4px);
    }
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .logo-container {
      margin-bottom: 1.6rem;
      text-align: center;
      position: relative;
    }
    .logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--dhvsu-gold);
      padding: 2px;
      background: #fff;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }
    .logo:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    .helper-text {
      color: #666;
      font-size: 1rem;
      line-height: 1.5;
      margin-bottom: 1.5rem;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #004080 0%, #0060bf 100%);
      min-height: 44px;
      padding: 0.9rem 1.6rem;
      margin-top: 1.2rem;
      display: inline-block;
      border-radius: 12px;
      width: auto;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,64,128,0.25);
      transition: all 0.3s;
    }
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,64,128,0.3);
      background: linear-gradient(135deg, #003366 0%, #0070cc 100%);
    }
    
    /* Mobile responsive improvements */
    @media (max-width: 480px) {
      body {
        padding: 1rem 0.8rem;
      }
      .container { 
        padding: 1.8rem 1.3rem; 
        width: 100%;
        max-width: 100%;
        border-radius: 20px;
      }
      h2 { 
        font-size: 1.8rem; 
        margin-bottom: 1rem;
      }
      .helper-text {
        font-size: 0.95rem;
        margin-bottom: 1.2rem;
      }
      button, input[type="password"] { 
        padding: 13px; 
        font-size: 1rem; 
        border-radius: 12px;
        height: 52px; /* Taller touchpoints for mobile */
      }
      .reset-btn {
        height: 54px;
        font-size: 1.15rem;
      }
      label {
        font-size: 1rem;
      }
      .back-link {
        width: 100%;
        justify-content: center;
        margin-top: 1.2rem;
        padding: 0.8rem;
        border-radius: 12px;
      }
      .eye-icon {
        padding: 12px;
        min-width: 48px;
        min-height: 48px;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .logo {
        width: 65px;
        height: 65px;
      }
      .password-strength {
        height: 6px;
      }
    }
    
    /* iPhone 5/SE/Small Phones */
    @media (max-width: 360px) {
      .container {
        padding: 1.5rem 1.1rem;
      }
      h2 {
        font-size: 1.6rem;
      }
      input[type="password"] {
        font-size: 0.95rem;
      }
      .logo {
        width: 60px;
        height: 60px;
      }
    }
    #iframe-form {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-container">
      <img src="Don_Honorio_Ventura_State_University_logo.png" alt="Pampanga State University Logo" class="logo">
    </div>
    <h2>Reset Password</h2>
    <div class="helper-text">Please create a new password for your account.</div>
    <form id="reset-form">
      <div class="form-group">
        <label for="password">New Password</label>
        <div class="password-container">
          <input type="password" id="password" name="password" required minlength="8" placeholder="Enter new password (min. 8 characters)" aria-describedby="password-error">
          <button type="button" class="eye-icon" id="toggle-password" aria-label="Show or hide password">
            <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            <svg id="eye-closed" style="display:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.293-3.95M6.634 6.634A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.956 9.956 0 01-4.043 5.306M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18"/>
            </svg>
          </button>
        </div>
        <div class="password-strength-container">
          <div class="password-strength" id="password-strength"></div>
          <div class="strength-text" id="strength-text">Password strength</div>
        </div>
        <div class="error-message" id="password-error"></div>
      </div>
      
      <div class="form-group">
        <label for="confirm">Confirm New Password</label>
        <div class="password-container">
          <input type="password" id="confirm" name="confirm" required minlength="8" placeholder="Re-enter your password" aria-describedby="confirm-error">
          <button type="button" class="eye-icon" id="toggle-confirm" aria-label="Show or hide password">
            <svg id="confirm-eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            <svg id="confirm-eye-closed" style="display:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.293-3.95M6.634 6.634A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.956 9.956 0 01-4.043 5.306M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18"/>
            </svg>
          </button>
        </div>
        <div class="error-message" id="confirm-error"></div>
      </div>
      
      <button type="submit" id="reset-btn" class="reset-btn">
        <span id="reset-btn-text">Reset Password</span>
        <span class="spinner" id="reset-spinner" style="display:none;"></span>
      </button>
    </form>
    <div class="message" id="message" aria-live="assertive"></div>
    <a href="index.html" class="back-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Login
    </a>
  </div>
  
  <!-- Hidden iframe for form submission -->
  <iframe name="hidden-iframe" id="hidden-iframe" style="display:none;"></iframe>
  
  <!-- Form that will be submitted to the iframe to avoid CORS -->
  <form id="iframe-form" target="hidden-iframe" method="post" action="https://script.google.com/macros/s/AKfycbzIeasHQeX6PN4VRAOzlmPQkSMDv8CNnz5d2YQZqfArThGrzGAxiMtyiVGYgIKZRZ7u/exec">
    <input type="hidden" name="action" value="validateResetToken">
    <input type="hidden" name="email" id="iframe-email">
    <input type="hidden" name="token" id="iframe-token">
    <input type="hidden" name="callback" value="handleValidateResponse">
  </form>
  
  <!-- Form for reset password -->
  <form id="iframe-reset-form" target="hidden-iframe" method="post" action="https://script.google.com/macros/s/AKfycbzIeasHQeX6PN4VRAOzlmPQkSMDv8CNnz5d2YQZqfArThGrzGAxiMtyiVGYgIKZRZ7u/exec" style="display:none;">
    <input type="hidden" name="action" value="resetPassword">
    <input type="hidden" name="email" id="reset-email">
    <input type="hidden" name="token" id="reset-token">
    <input type="hidden" name="password" id="reset-password">
    <input type="hidden" name="callback" value="handleResetResponse">
  </form>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIeasHQeX6PN4VRAOzlmPQkSMDv8CNnz5d2YQZqfArThGrzGAxiMtyiVGYgIKZRZ7u/exec';
    const messageBox = document.getElementById('message');
    const resetForm = document.getElementById('reset-form');
    
    // Get token and email from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const email = urlParams.get('email');
    
    if (!token || !email) {
      document.getElementById('reset-form').style.display = 'none';
      document.getElementById('message').textContent = 'Invalid reset link. Please request a new password reset.';
      document.getElementById('message').classList.add('error');
      document.getElementById('message').style.display = 'block';
    } else {
      // Set values for validation
      document.getElementById('iframe-email').value = email;
      document.getElementById('iframe-token').value = token;
      
      // Also set them for the reset form
      document.getElementById('reset-email').value = email;
      document.getElementById('reset-token').value = token;
      
      // Validate token on page load
      validateToken();
    }
    
    // Handle validation response
    window.handleValidateResponse = function(response) {
      if (response && response.success) {
        // Token is valid, show the reset form
        resetForm.style.display = 'block';
        messageBox.style.display = 'none';
      } else {
        // Token is invalid, show error message
        resetForm.style.display = 'none';
        messageBox.textContent = response.message || 'Invalid or expired reset link. Please request a new password reset.';
        messageBox.className = 'message error';
        messageBox.style.display = 'block';
      }
    };
    
    // Handle reset password response
    window.handleResetResponse = function(response) {
      const resetBtn = document.getElementById('reset-btn');
      const resetBtnText = document.getElementById('reset-btn-text');
      const spinner = document.getElementById('reset-spinner');
      
      // Reset button state
      if (resetBtn) resetBtn.disabled = false;
      if (resetBtnText) resetBtnText.style.display = 'inline';
      if (spinner) spinner.style.display = 'none';
      
      if (response && response.success) {
        // Password was reset successfully
        resetForm.style.display = 'none';
        messageBox.textContent = response.message || 'Your password has been reset successfully. You can now log in with your new password.';
        messageBox.className = 'message success';
        messageBox.style.display = 'block';
        
        // Add login link
        const loginLink = document.createElement('a');
        loginLink.href = 'index.html';
        loginLink.className = 'login-link';
        loginLink.textContent = 'Go to Login';
        loginLink.style.display = 'inline-block';
        loginLink.style.marginTop = '15px';
        loginLink.style.padding = '10px 20px';
        loginLink.style.background = '#800000';
        loginLink.style.color = '#fff';
        loginLink.style.borderRadius = '5px';
        loginLink.style.textDecoration = 'none';
        
        messageBox.appendChild(document.createElement('br'));
        messageBox.appendChild(document.createElement('br'));
        messageBox.appendChild(loginLink);
      } else {
        // Error resetting password
        messageBox.textContent = response.message || 'An error occurred while resetting your password. Please try again or request a new reset link.';
        messageBox.className = 'message error';
        messageBox.style.display = 'block';
      }
    };
    
    // Add this improved error handling for connection issues with timeout
    let connectionTimedOut = false;
    const connectionTimeout = setTimeout(function() {
      connectionTimedOut = true;
      showConnectionError();
    }, 5000); // 5 second timeout
    
    function showConnectionError() {
      if (connectionTimedOut) {
        resetForm.style.display = 'none';
        messageBox.innerHTML = '<strong>Connection error. Please check your internet connection and try again.</strong>' +
                              '<div style="margin-top: 20px; text-align: left;">' +
                              '<h3 style="font-size: 1.1rem; color: #555;">Why am I seeing this error?</h3>' +
                              '<ul style="padding-left: 20px;">' +
                              '<li>Password reset links are valid for only 1 hour after being requested</li>' +
                              '<li>The link may have been used already (each link can only be used once)</li>' +
                              '<li>The link might be incomplete or incorrect (check if it was copied fully)</li>' +
                              '</ul></div>';
        messageBox.className = 'message error';
        messageBox.style.display = 'block';
        
        // Add a request new link button
        const requestNewBtn = document.createElement('a');
        requestNewBtn.href = 'forgot_password.html';
        requestNewBtn.textContent = 'Request New Reset Link';
        requestNewBtn.style.display = 'inline-block';
        requestNewBtn.style.marginTop = '15px';
        requestNewBtn.style.padding = '12px 24px';
        requestNewBtn.style.background = '#004080';
        requestNewBtn.style.color = '#fff';
        requestNewBtn.style.borderRadius = '5px';
        requestNewBtn.style.textDecoration = 'none';
        requestNewBtn.style.fontWeight = 'bold';
        
        messageBox.appendChild(document.createElement('br'));
        messageBox.appendChild(document.createElement('br'));
        messageBox.appendChild(requestNewBtn);
      }
    }
    
    // Function to receive messages from the iframe
    window.addEventListener('message', function(event) {
      clearTimeout(connectionTimeout); // Clear the timeout as we got a response
      
      if (event.data && event.data.action === 'validate_token_response') {
        handleValidateResponse(event.data);
      } else if (event.data && event.data.action === 'reset_password_response') {
        handleResetResponse(event.data);
      }
    });
    
    // Listen for iframe load events to detect navigation issues
    document.getElementById('hidden-iframe').addEventListener('load', function() {
      // If we still get a load event but no message, check for errors
      setTimeout(function() {
        if (connectionTimedOut) {
          // Already showing error, do nothing
        } else if (messageBox.style.display === 'none' || messageBox.textContent.includes('Verifying')) {
          // Still waiting, which means no response came through
          connectionTimedOut = true;
          showConnectionError();
        }
      }, 1000); // Give a second for any postMessage to arrive
    });
    
    function validateToken() {
      messageBox.textContent = "Verifying reset link...";
      messageBox.className = "message";
      messageBox.style.display = 'block';
      
      // Submit the validation form to the iframe
      document.getElementById('iframe-form').submit();
    }
    
    // Add form submit handler
    document.getElementById('reset-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const password = document.getElementById('password').value;
      const confirm = document.getElementById('confirm').value;
      const passwordError = document.getElementById('password-error');
      const confirmError = document.getElementById('confirm-error');
      const resetBtn = document.getElementById('reset-btn');
      const resetBtnText = document.getElementById('reset-btn-text');
      const spinner = document.getElementById('reset-spinner');
      
      // Reset errors
      passwordError.textContent = '';
      passwordError.style.display = 'none';
      confirmError.textContent = '';
      confirmError.style.display = 'none';
      
      // Validate password
      if (password.length < 8) {
        passwordError.textContent = 'Password must be at least 8 characters';
        passwordError.style.display = 'block';
        return;
      }
      
      // Validate password match
      if (password !== confirm) {
        confirmError.textContent = 'Passwords do not match';
        confirmError.style.display = 'block';
        return;
      }
      
      // Set the new timeout for submission
      connectionTimedOut = false;
      clearTimeout(connectionTimeout);
      setTimeout(function() {
        if (!connectionTimedOut) {
          connectionTimedOut = true;
          showConnectionError();
        }
      }, 8000); // 8 second timeout for submission
      
      // Show loading state
      resetBtn.disabled = true;
      resetBtnText.style.display = 'none';
      spinner.style.display = 'inline-block';
      
      // Set the password in the form
      document.getElementById('reset-password').value = password;
      
      // Submit the form
      document.getElementById('iframe-reset-form').submit();
    });
    
    // Add password toggle functionality
    document.getElementById('toggle-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('password');
      const eyeOpen = document.getElementById('eye-open');
      const eyeClosed = document.getElementById('eye-closed');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'block';
      } else {
        passwordInput.type = 'password';
        eyeOpen.style.display = 'block';
        eyeClosed.style.display = 'none';
      }
    });
    
    document.getElementById('toggle-confirm').addEventListener('click', function() {
      const confirmInput = document.getElementById('confirm');
      const eyeOpen = document.getElementById('confirm-eye-open');
      const eyeClosed = document.getElementById('confirm-eye-closed');
      
      if (confirmInput.type === 'password') {
        confirmInput.type = 'text';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'block';
      } else {
        confirmInput.type = 'password';
        eyeOpen.style.display = 'block';
        eyeClosed.style.display = 'none';
      }
    });
    
    // Add password strength indicator
    document.getElementById('password').addEventListener('input', function(e) {
      const password = e.target.value;
      const strengthBar = document.getElementById('password-strength');
      const strengthText = document.getElementById('strength-text');
      
      // Check password strength
      let strength = 0;
      
      // Length check
      if (password.length >= 8) strength += 1;
      if (password.length >= 12) strength += 1;
      
      // Character check
      if (/[A-Z]/.test(password)) strength += 1;
      if (/[a-z]/.test(password)) strength += 1;
      if (/[0-9]/.test(password)) strength += 1;
      if (/[^A-Za-z0-9]/.test(password)) strength += 1;
      
      // Update strength bar
      let width = '0%';
      let color = '#e74c3c';
      let text = 'Weak';
      
      if (strength >= 5) {
        width = '100%';
        color = '#27ae60';
        text = 'Strong';
      } else if (strength >= 3) {
        width = '66%';
        color = '#f39c12';
        text = 'Medium';
      } else if (strength >= 1) {
        width = '33%';
        color = '#e74c3c';
        text = 'Weak';
      }
      
      strengthBar.style.width = width;
      strengthBar.style.backgroundColor = color;
      strengthText.textContent = password.length > 0 ? text : 'Password strength';
    });
  </script>
</body>
</html>
