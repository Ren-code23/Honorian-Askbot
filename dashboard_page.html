<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Honorian AskBot Dashboard - DHVSU</title>
    <style>
        :root {
            --dhvsu-maroon: #800000;
            --dhvsu-gold: #FFD700;
            --light-maroon: #A52A2A;
            --gray: #f7f7f7;
            --bubble-radius: 22px;
            --navbar-height: 60px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: #f7f7f7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* NAVBAR */
        .navbar {
            width: 100%;
            height: var(--navbar-height);
            background: var(--dhvsu-maroon);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2.2rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .navbar-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fff;
            padding: 3px;
        }
        .navbar-title {
            font-size: 1.18rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .navbar-links {
            display: flex;
            align-items: center;
            gap: 28px;
            height: 100%;
        }
        .navbar-link {
            color: #fff;
            text-decoration: none;
            font-size: 1.05rem;
            font-weight: 500;
            padding: 6px 0 4px 0;
            border-bottom: 2.5px solid transparent;
            transition: border-color 0.2s, color 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            height: var(--navbar-height);
        }
        .navbar-link.active,
        .navbar-link:hover {
            color: #fff;
            border-bottom: 2.5px solid var(--dhvsu-gold);
        }
        .navbar-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            margin-left: 8px;
            background: #fff;
        }
        .navbar-logout {
            color: #fff;
            text-decoration: none;
            font-size: 1.05rem;
            font-weight: 500;
            padding: 6px 0 4px 0;
            border-bottom: 2.5px solid transparent;
            background: none;
            border: none;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            height: var(--navbar-height);
        }
        .navbar-logout:hover {
            color: var(--dhvsu-gold);
            border-bottom: 2.5px solid var(--dhvsu-gold);
        }
        @media (max-width: 900px) {
            .navbar { padding: 0 0.7rem; }
            .navbar-title { font-size: 1rem; }
            .navbar-links { gap: 14px; }
        }
        @media (max-width: 600px) {
            .navbar { flex-direction: column; height: auto; padding: 0.5rem 0.2rem; }
            .navbar-left { margin-bottom: 6px; }
            .navbar-links { gap: 8px; flex-wrap: wrap; }
            .navbar-link, .navbar-logout { height: 44px; font-size: 0.98rem; }
        }

    #user-notification {
        max-width: 700px;
        margin: 0 auto 12px auto;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        font-size: 1rem;
    }
    
    main {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 1.5rem 0 0.5rem 0;
        background: #f7f7f7;
    }
    
    .chatbot-container {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 2px 12px rgba(128,0,0,0.06);
        width: 100%;
        max-width: 480px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        margin: 0 auto;
        border: 1.5px solid #f0e6e6;
    }
    
    .chat-header {
        background: #fff;
        color: var(--dhvsu-maroon);
        padding: 1rem 1.2rem 0.7rem 1.2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1.5px solid #f3e3e3;
    }
    
    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chat-header-left svg {
        display: inline-block;
        vertical-align: middle;
        margin-bottom: 2px;
        width: 26px;
        height: 26px;
    }
    
    .chat-header h2 {
        margin-left: 0;
        font-size: 1.18rem;
        font-weight: 700;
        display: inline-block;
        vertical-align: middle;
    }
    
    .connection-status {
        font-size: 0.9rem;
        padding: 4px 12px;
        border-radius: 12px;
        background: #4CAF50;
        color: white;
    }
    
    .connection-status.offline {
        background: #f44336;
    }
    
    .chat-messages {
        flex: 1;
        padding: 1.2rem 0.7rem 0.7rem 0.7rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        min-height: 350px;
        max-height: 60vh;
        background: #f7f7f7;
    }
    
    .message {
        margin-bottom: 1.1rem;
        max-width: 85%;
        padding: 13px 16px;
        border-radius: var(--bubble-radius);
        position: relative;
        white-space: pre-line;
        font-size: 1.05rem;
        box-shadow: 0 1px 4px rgba(128,0,0,0.04);
        animation: chatBubbleIn 0.4s;
    }
    
    @keyframes chatBubbleIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .bot-message {
        align-self: flex-start;
        background: #f0f0f0;
        color: #333;
        border-top-left-radius: 6px;
        border-bottom-right-radius: 22px;
        border: 1.5px solid #eee;
    }
    
    .user-message {
        align-self: flex-end;
        background: var(--dhvsu-maroon);
        color: white;
        border-top-right-radius: 6px;
        border-bottom-left-radius: 22px;
        border: 1.5px solid var(--dhvsu-maroon);
    }
    
    .message-time {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 7px;
        text-align: right;
    }
    
    .welcome-message {
        text-align: center;
        background: #fff;
        padding: 18px;
        border-radius: 12px;
        margin: 0 auto 12px auto;
        max-width: 98%;
        box-shadow: 0 1px 4px rgba(128,0,0,0.04);
    }
    
    .welcome-message h3 {
        color: var(--dhvsu-maroon);
        margin-bottom: 8px;
        font-size: 1.08rem;
    }
    
    .welcome-message p {
        color: #666;
        margin-bottom: 12px;
    }
    
    .chat-examples {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px;
        margin-top: 10px;
    }
    
    .example-query {
        background: #f7f7f7;
        padding: 8px;
        border-radius: 7px;
        cursor: pointer;
        text-align: center;
        transition: background 0.3s;
        border: 1.5px solid #eee;
    }
    
    .example-query:hover {
        background: #FFD700;
        color: var(--dhvsu-maroon);
    }
    
    .chat-input {
        display: flex;
        align-items: center;
        padding: 0.7rem 0.7rem 0.7rem 0.7rem;
        background: transparent;
        border-top: none;
        position: relative;
    }
    
    .chat-input input {
        flex: 1;
        padding: 15px 18px;
        border: 1.5px solid #e0e0e0;
        border-radius: 30px;
        font-size: 1.08rem;
        margin-right: 10px;
        background: #fff;
        transition: border-color 0.3s, box-shadow 0.3s;
        box-shadow: 0 1px 4px rgba(128,0,0,0.04);
    }
    
    .chat-input input:focus {
        outline: none;
        border-color: var(--dhvsu-maroon);
        box-shadow: 0 0 8px rgba(165, 42, 42, 0.13);
        background: #fff;
    }
    
    .send-btn {
        background: var(--dhvsu-maroon);
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.3s, box-shadow 0.3s;
        box-shadow: 0 1px 4px rgba(128,0,0,0.07);
    }
    
    .send-btn:hover {
        background: var(--dhvsu-gold);
        color: var(--dhvsu-maroon);
        box-shadow: 0 2px 8px rgba(128,0,0,0.13);
    }
    
    .send-btn:disabled {
        background: #cccccc;
        color: #fff;
        cursor: not-allowed;
    }
    
    .send-icon {
        width: 20px;
        height: 20px;
        fill: white;
    }
    
    .typing-indicator {
        display: none;
        align-self: flex-start;
        padding: 8px 16px;
        background: #f0f0f0;
        border-radius: 20px;
        margin-bottom: 10px;
    }
    
    .typing-animation {
        display: flex;
    }
    
    .dot {
        width: 8px;
        height: 8px;
        background: #777;
        border-radius: 50%;
        margin: 0 2px;
        animation: bounce 1.5s infinite ease-in-out;
    }
    
    .dot:nth-child(1) { animation-delay: 0s; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes bounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }
    
    .feedback-buttons {
        display: flex;
        justify-content: flex-end;
        margin-top: 5px;
        gap: 8px;
    }
    
    .feedback-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #777;
        font-size: 0.98rem;
        display: flex;
        align-items: center;
        padding: 2px 7px;
        border-radius: 5px;
        transition: background 0.2s;
    }
    
    .feedback-btn:hover {
        background: #FFD700;
        color: var(--dhvsu-maroon);
    }
    
    .feedback-btn svg {
        margin-right: 3px;
        width: 15px;
        height: 15px;
    }
    
    @media (max-width: 768px) {
        .university-name { font-size: 1rem; }
        main { padding: 0.5rem 0; }
        .chatbot-container { max-width: 99%; }
        .message { max-width: 98%; }
        .chat-messages { padding: 0.7rem 0.2rem 0.2rem 0.2rem; }
    }
    
    @media (max-width: 576px) {
        .logo { width: 32px; height: 32px; font-size: 14px; }
        .university-name { font-size: 0.9rem; }
        .user-info { margin-right: 6px; }
        .logout-btn { padding: 5px 8px; font-size: 0.95rem; }
        .chat-examples { grid-template-columns: 1fr; }
        .chatbot-container { padding: 0; }
    }

    .welcome-admin-card { display: none; }
    .chatbot-container { margin: 0 auto; float: none; }
    .chat-welcome-bar {
        background: #f7f7f7;
        color: #800000;
        font-size: 1.05rem;
        text-align: left;
        padding: 0.7rem 1.2rem 0.7rem 1.2rem;
        border-bottom: 1px solid #f0e6e6;
        font-weight: 500;
        border-radius: 0 0 12px 12px;
        margin-bottom: 0.5rem;
    }
    @media (max-width: 900px) {
        .chatbot-container { margin: 0 auto; }
    }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="navbar-left">
            <img src="Don_Honorio_Ventura_State_University_logo.png" alt="DHVSU Logo" class="navbar-logo">
            <span class="navbar-title">Don Honorio Ventura State University</span>
        </div>
        <div class="navbar-links" id="navbar-links">
            <a href="dashboard_page.html" class="navbar-link active">Dashboard</a>
            <a href="profile.html" class="navbar-link" id="profile-link-navbar">Profile <img id="navbar-profile-avatar" src="default_profile.png" alt="Profile" class="navbar-avatar"></a>
            <a href="faq.html" class="navbar-link">FAQs</a>
            <span id="admin-panel-navbar-link"></span>
            <button class="navbar-logout" id="logout-btn">Logout</button>
        </div>
    </nav>

    <div id="user-notification" style="display:none; max-width: 1200px; margin: 0 auto; margin-top: 10px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 500; background: #d4edda; color: #155724; border: 1px solid #c3e6cb;"></div>

    <div id="announcements-section" style="display:none; margin-bottom: 1.5rem;">
      <div style="background:#fffbe6; border:1.5px solid #FFD700; border-radius:10px; padding:1.2rem;">
        <h3 style="color:#800000; margin-bottom:0.7em;">üì¢ Announcements</h3>
        <ul id="announcements-list" style="list-style:disc; padding-left:1.5em; color:#333;"></ul>
      </div>
    </div>

    <div id="student-welcome" style="background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(128,0,0,0.07); margin:1.5em auto 1em auto; max-width:480px; padding:1.2em 1.5em; display:flex; align-items:center; gap:1.5em;">
      <img id="student-avatar" src="default_profile.png" style="width:56px;height:56px;border-radius:50%;border:2px solid #FFD700;">
      <div>
        <div style="font-size:1.2em;font-weight:600;color:#800000;" id="student-greeting"></div>
        <div style="font-size:0.98em;color:#555;" id="student-stats"></div>
      </div>
    </div>

    <main>
        <div class="chatbot-container">
            <div class="chat-header">
                <div class="chat-header-left">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    <h2>Honorian AskBot</h2>
                </div>
                <span class="connection-status" id="connection-status">Online</span>
            </div>
            <div class="chat-welcome-bar" id="chat-welcome-bar" style="display:none;"></div>
            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <h3>Welcome to Honorian AskBot! üëã</h3>
                    <p>I'm here to help you with information about DHVSU. You can ask me about enrollment procedures, classroom locations, and other academic concerns.</p>
                    <div class="chat-examples">
                        <div class="example-query">Where is the Admissions Office?</div>
                        <div class="example-query">How do I enroll as a freshman?</div>
                        <div class="example-query">What documents do I need for enrollment?</div>
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typing-indicator">
                <div class="typing-animation">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>

            <div class="chat-input">
                <input type="text" id="user-input" placeholder="Type your question here..." autocomplete="off">
                <button class="send-btn" id="send-btn">
                    <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>

            <div id="faq-suggestions" style="margin-top:0.5em;"></div>
        </div>
    </main>

    <footer>
        &copy; 2025 Don Honorio Ventura State University. All Rights Reserved.
    </footer>

    <div id="chat-history-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:400px;width:95%;border-radius:12px;padding:2em;box-shadow:0 8px 32px rgba(128,0,0,0.13);position:relative;">
        <h3 style="color:#800000;margin-bottom:1em;">My Recent Chats</h3>
        <div id="chat-history-list" style="max-height:300px;overflow-y:auto;"></div>
        <button onclick="document.getElementById('chat-history-modal').style.display='none'" style="margin-top:1em;">Close</button>
      </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyT5rAzRKuZNhu0_GIjnx3AJs2Mpy6NAXlrP41dU8ZSWoRDO0N1dw3tijZoHDnysGDR/exec';
        
        // Set to 'true' to enable offline mode for testing without Apps Script
        const OFFLINE_MODE = false;
        // *******************************************
        
        // User authentication check
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            if (!currentUser) {
                // Redirect to login page if not logged in
                window.location.href = 'index.html';
                return;
            }
            
            // Display username
            const displayUsername = document.getElementById('display-username');
            if (displayUsername) {
                displayUsername.textContent = currentUser.username;
            }
            
            // Move Admin Panel button to navbar if admin
            if (currentUser && currentUser.role === 'admin') {
                const adminPanelNavbar = document.getElementById('admin-panel-navbar-link');
                if (adminPanelNavbar) {
                    adminPanelNavbar.innerHTML = `<a href="admin.html" class="btn" style="margin-left:12px; background:#FFD700; color:#800000; font-weight:bold; border-radius:5px; padding:8px 14px; text-decoration:none;">Admin Panel</a>`;
                }
            }
            
            // Show welcome bar in chat header
            const chatWelcomeBar = document.getElementById('chat-welcome-bar');
            if (chatWelcomeBar && currentUser) {
                chatWelcomeBar.style.display = 'block';
                chatWelcomeBar.textContent = `Welcome, ${currentUser.username}${currentUser.role === 'admin' ? ' (Administrator)' : ''}`;
            }
            
            // Set connection status
            checkConnection();
            
            // Focus on input field
            document.getElementById('user-input').focus();

            // --- NEW: Load and show profile picture in dashboard header ---
            fetchAndRenderUserProfilePicNavbar();
        });
        
        // Connection checker
        function checkConnection() {
            const connectionStatus = document.getElementById('connection-status');
            
            if (OFFLINE_MODE) {
                connectionStatus.textContent = 'Offline';
                connectionStatus.classList.add('offline');
                return;
            }
            
            // Test connection to Apps Script
            fetch(APPS_SCRIPT_URL, { method: 'HEAD', mode: 'no-cors' })
                .then(() => {
                    connectionStatus.textContent = 'Online';
                    connectionStatus.classList.remove('offline');
                })
                .catch(() => {
                    connectionStatus.textContent = 'Offline';
                    connectionStatus.classList.add('offline');
                    console.warn('Unable to connect to backend. Using fallback mode.');
                });
        }
        
        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', function() {
            // Clear session data
            sessionStorage.removeItem('currentUser');
            // Redirect to login page
            window.location.href = 'index.html';
        });
        
        // Chat functionality
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        
        // Format text with bullet points
        function formatText(text) {
            // Check if text contains number lists (like "1. ", "2. ", etc.)
            if (/\d+\.\s/.test(text)) {
                // Split by line breaks
                const lines = text.split('\n');
                let formatted = '';
                
                // Process each line
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    // Check if line starts with a number followed by period
                    if (/^\d+\.\s/.test(line)) {
                        formatted += `<div class="list-item">‚Ä¢ ${line.replace(/^\d+\.\s/, '')}</div>`;
                    } else {
                        formatted += `${line}\n`;
                    }
                }
                return formatted;
            }
            return text;
        }
        
        // Get formatted time
        function getTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Add user message to chat
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'user-message');
            messageElement.textContent = message;
            
            // Add time
            const timeElement = document.createElement('div');
            timeElement.classList.add('message-time');
            timeElement.textContent = getTime();
            messageElement.appendChild(timeElement);
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Add bot message to chat
        function addBotMessage(message, suggestions) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'bot-message');
            messageElement.innerHTML = formatText(message);
            // Add time
            const timeElement = document.createElement('div');
            timeElement.classList.add('message-time');
            timeElement.textContent = getTime();
            messageElement.appendChild(timeElement);
            // Add suggestions if present
            if (Array.isArray(suggestions) && suggestions.length > 0) {
                const suggDiv = document.createElement('div');
                suggDiv.style.marginTop = '10px';
                suggDiv.innerHTML = '<span style="color:#800000;font-weight:600;">Did you mean:</span> ';
                suggestions.forEach(s => {
                    const btn = document.createElement('button');
                    btn.textContent = s;
                    btn.className = 'btn';
                    btn.style.margin = '4px 6px 4px 0';
                    btn.style.background = '#FFD700';
                    btn.style.color = '#800000';
                    btn.style.fontWeight = 'bold';
                    btn.style.borderRadius = '6px';
                    btn.style.padding = '4px 10px';
                    btn.style.fontSize = '0.98em';
                    btn.setAttribute('aria-label', 'Ask about ' + s);
                    btn.onclick = () => {
                        userInput.value = s;
                        processUserInput();
                    };
                    suggDiv.appendChild(btn);
                });
                messageElement.appendChild(suggDiv);
            }
            // Add feedback buttons
            const feedbackDiv = document.createElement('div');
            feedbackDiv.classList.add('feedback-buttons');
            feedbackDiv.innerHTML = `
                <span style="margin-right:8px;">Was this helpful?</span>
                <button class="feedback-btn" aria-label="Helpful" title="Helpful" style="font-size:1.2em;">üëç</button>
                <button class="feedback-btn" aria-label="Not Helpful" title="Not Helpful" style="font-size:1.2em;">üëé</button>
                <input type="text" class="feedback-comment" placeholder="Optional comment..." style="margin-left:8px; padding:2px 6px; border-radius:5px; border:1px solid #eee; font-size:0.95em; width:120px;">
            `;
            feedbackDiv.querySelectorAll('button')[0].onclick = function() {
                const comment = feedbackDiv.querySelector('.feedback-comment').value;
                logFeedback('positive', message, comment);
                feedbackDiv.style.display = 'none';
                showFeedbackThankYou(messageElement);
            };
            feedbackDiv.querySelectorAll('button')[1].onclick = function() {
                const comment = feedbackDiv.querySelector('.feedback-comment').value;
                logFeedback('negative', message, comment);
                feedbackDiv.style.display = 'none';
                showFeedbackThankYou(messageElement);
            };
            messageElement.appendChild(feedbackDiv);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Log feedback to improve bot responses (optional)
        function logFeedback(type, message, comment) {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                const username = currentUser ? currentUser.username : 'anonymous';
                const formData = new FormData();
                formData.append('action', 'logFeedback');
                formData.append('username', username);
                formData.append('message', message);
                formData.append('feedbackType', type);
                formData.append('comment', comment);
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // handle success/error
                })
                .catch(error => {
                    // handle error
                });
            } catch (error) {
                // handle error
            }
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }
        
        let chatCooldown = false;

        async function processUserInput() {
            if (chatCooldown) return; // Prevent sending if in cooldown
            const message = userInput.value.trim();
            if (message === '') return;
            userInput.disabled = true;
            sendBtn.disabled = true;
            chatCooldown = true;
            setTimeout(() => {
                chatCooldown = false;
                userInput.disabled = false;
                sendBtn.disabled = false;
            }, 5000);
            userInput.value = '';
            addUserMessage(message);
            showTypingIndicator();
            const thinkingTime = Math.min(1000 + (message.length * 20), 3000);
            setTimeout(async () => {
                try {
                    // Query the database for a response using Apps Script
                    const responseObj = await queryDatabaseViaAppsScript(message, true);
                    hideTypingIndicator();
                    if (typeof responseObj === 'object' && responseObj !== null && 'response' in responseObj) {
                        addBotMessage(responseObj.response, responseObj.suggestions);
                    } else {
                        addBotMessage(responseObj);
                    }
                } catch (error) {
                    console.error('Error processing message:', error);
                    hideTypingIndicator();
                    addBotMessage("I'm having some technical difficulties. Please try again later.");
                }
            }, thinkingTime);
        }
        
        // Function to query Google Sheets database via Apps Script
        async function queryDatabaseViaAppsScript(question, wantSuggestions) {
            try {
                if (OFFLINE_MODE) {
                    return getOfflineResponse(question);
                }
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                const username = currentUser ? currentUser.username : 'anonymous';
                const formData = new FormData();
                formData.append('action', 'queryFAQ');
                formData.append('question', question);
                formData.append('username', username);
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.success) {
                    if (wantSuggestions && ('suggestions' in data)) {
                        return data;
                    }
                    return data.response;
                } else {
                    console.error('Error from Apps Script:', data.error);
                    return getDefaultResponse();
                }
            } catch (error) {
                console.error('Error querying database via Apps Script:', error);
                return getDefaultResponse();
            }
        }
        
        // Function to get response in offline mode
        function getOfflineResponse(question) {
            question = question.toLowerCase();
            
            // Enhanced offline responses
            const offlineResponses = {
                "admission": "For admission inquiries, please visit the Admissions Office on the first floor of the Administration Building. You can also contact them at admissions@dhvsu.edu.ph or call at (045) 123-4567.",
                "Tuition": "Tuition fees are free for all students enrolled in DHVSU. However, there may be additional fees for laboratory courses, miscellaneous fees, and other services.",
                "scholarship": "DHVSU offers various scholarship programs including:\n1. Academic Excellence Scholarship\n2. Athletic Scholarship\n3. Cultural Scholarship\n4. Financial Need-based Scholarship\n\nVisit the Scholarship Office or check the university website for application details.",
                "enrollment": "The enrollment process involves:\n1. Online registration\n2. Subject selection\n3. Fee assessment\n4. Payment\n5. Validation\n\nRegular enrollment usually starts three weeks before classes begin.",
                "schedule": "Class schedules are posted on the university portal and department bulletin boards two weeks before classes start. You can also check with your department secretary for the most updated schedule.",
                "requirement": "General requirements include:\n1. Form 138 (Report Card)\n2. Certificate of Good Moral Character\n3. PSA Birth Certificate\n4. Medical clearance\n5. 2x2 ID pictures\n\nSpecific programs may have additional requirements.",
                "uniform": "Students are required to wear the university uniform on specific days of the week. The standard uniform consists of maroon and white combinations with the university logo.",
                "library": "The university library is open Monday to Friday from 8:00 AM to 7:00 PM, and Saturday from 8:00 AM to 5:00 PM. It's located at the second floor of the Academic Building."
            };
            
            // Check if question contains any keywords
            for (const [keyword, response] of Object.entries(offlineResponses)) {
                if (question.includes(keyword)) {
                    return response;
                }
            }
            
            // Check for specific example responses
            if (question.includes("admissions office")) {
                return "The Admissions Office is located on the first floor of the Administration Building, to the right of the main entrance. It's open Monday through Friday from 8:00 AM to 5:00 PM.";
            } else if (question.includes("enroll") && question.includes("freshman")) {
                return "To enroll as a freshman at DHVSU, you need to:\n1. Submit an online application through the university portal\n2. Take the entrance examination\n3. Submit required documents including Form 138, birth certificate, and good moral character certification\n4. Wait for acceptance letter\n5. Complete the enrollment process by paying the fees and selecting your courses";
            } else if (question.includes("documents") && question.includes("enrollment")) {
                return "For enrollment, you need:\n1. Original and photocopy of Form 138 (Report Card)\n2. Certificate of Good Moral Character\n3. NSO/PSA Birth Certificate\n4. 2x2 ID pictures (white background)\n5. Barangay Clearance\n6. Certificate of Residency";
            }
            
            // Default fallback response
            return getDefaultResponse();
        }
        
        // Function to get a default response when no match is found
        function getDefaultResponse() {
            const defaultResponses = [
                "I'm sorry, I don't have that information yet. Please try asking another question or visit the university website for more details.",
                "I couldn't find an answer to that question. Would you like to ask something else?",
                "That information isn't in my database yet. Please try rephrasing your question or ask about another topic.",
                "I'm still learning! I don't have an answer for that yet. Can I help you with something else related to DHVSU?"
            ];
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }
        
        // Static responses for demo example queries
        const exampleResponses = {
            "Where is the Admissions Office?": "The Admissions Office is located on the first floor of the Administration Building, to the right of the main entrance. It's open Monday through Friday from 8:00 AM to 5:00 PM.",
            "How do I enroll as a freshman?": "To enroll as a freshman at DHVSU, you need to:\n1. Submit an online application through the university portal\n2. Take the entrance examination\n3. Submit required documents including Form 138, birth certificate, and good moral character certification\n4. Wait for acceptance letter\n5. Complete the enrollment process by paying the fees and selecting your courses",
            "What documents do I need for enrollment?": "For enrollment, you need:\n1. Original and photocopy of Form 138 (Report Card)\n2. Certificate of Good Moral Character\n3. NSO/PSA Birth Certificate\n4. 2x2 ID pictures (white background)\n5. Barangay Clearance\n6. Certificate of Residency",
        };
        
        // Handle example query clicks
        document.querySelectorAll('.example-query').forEach(example => {
            example.addEventListener('click', function() {
                const query = this.textContent;
                userInput.value = query;
                processUserInput();
            });
        });
        
        // Handle send button click
        sendBtn.addEventListener('click', processUserInput);
        
        // Handle enter key press
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processUserInput();
            }
        });
        
        // Handle input changes to enable/disable send button
        userInput.addEventListener('input', function() {
            if (this.value.trim() === '') {
                sendBtn.disabled = true;
            } else {
                sendBtn.disabled = false;
            }
        });
        
        // Initial state of send button
        sendBtn.disabled = true;

        function fetchAndRenderUserProfile() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) return;
            const formData = new FormData();
            formData.append('action', 'getUserProfile');
            formData.append('username', currentUser.username);
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.profile) {
                        const avatar = document.getElementById('navbar-profile-avatar');
                        avatar.src = data.profile.profilePic || 'default_profile.png';
                        avatar.onerror = function() { this.src = 'default_profile.png'; };
                        // Optionally update other profile info in the dashboard
                    }
                });
        }

        // Show a thank you message after feedback
        function showFeedbackThankYou(parent) {
            const thankYou = document.createElement('div');
            thankYou.textContent = 'Thank you for your feedback!';
            thankYou.style.color = '#155724';
            thankYou.style.background = '#d4edda';
            thankYou.style.borderRadius = '6px';
            thankYou.style.padding = '6px 12px';
            thankYou.style.marginTop = '8px';
            thankYou.style.fontSize = '0.95rem';
            thankYou.style.textAlign = 'center';
            thankYou.style.opacity = '1';
            parent.appendChild(thankYou);
            setTimeout(() => {
                thankYou.style.transition = 'opacity 0.7s';
                thankYou.style.opacity = '0';
                setTimeout(() => parent.removeChild(thankYou), 700);
            }, 2000);
        }

        // Show a notification to the user
        function showUserNotification(msg, isError) {
            const notif = document.getElementById('user-notification');
            notif.textContent = msg;
            notif.style.display = 'block';
            notif.style.background = isError ? '#f8d7da' : '#d4edda';
            notif.style.color = isError ? '#721c24' : '#155724';
            setTimeout(() => { notif.style.display = 'none'; }, 3500);
        }

        // Cloudinary config (replace with your own values)
        const CLOUDINARY_CLOUD_NAME = 'YOUR_CLOUD_NAME'; // e.g. 'dhvsu-askbot'
        const CLOUDINARY_UPLOAD_PRESET = 'YOUR_UNSIGNED_PRESET'; // e.g. 'askbot_profile_upload'

        // Add this function to fetch and set the navbar profile picture
        function setNavbarAvatarFromCache() {
            const avatar = document.getElementById('navbar-profile-avatar');
            const cachedPic = sessionStorage.getItem('profilePic');
            avatar.src = cachedPic && cachedPic !== '' ? cachedPic : 'default_profile.png';
            avatar.onerror = function() { this.src = 'default_profile.png'; };
        }

        function fetchAndRenderUserProfilePicNavbar() {
            setNavbarAvatarFromCache(); // Show cached image instantly
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) return;
            const formData = new FormData();
            formData.append('action', 'getUserProfile');
            formData.append('username', currentUser.username);
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.profile && data.profile.profilePic) {
                        sessionStorage.setItem('profilePic', data.profile.profilePic);
                        setNavbarAvatarFromCache();
                    }
                });
        }

        function fetchAnnouncements() {
            const formData = new FormData();
            formData.append('action', 'getAnnouncements');
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.announcements && data.announcements.length > 0) {
                        const section = document.getElementById('announcements-section');
                        const list = document.getElementById('announcements-list');
                        list.innerHTML = '';
                        data.announcements.forEach(a => {
                            const li = document.createElement('li');
                            li.textContent = a.message + (a.date ? ` (${new Date(a.date).toLocaleDateString()})` : '');
                            list.appendChild(li);
                        });
                        section.style.display = 'block';
                    }
                });
        }
        document.addEventListener('DOMContentLoaded', fetchAnnouncements);

        function renderStudentWelcome() {
            const user = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!user) return;
            document.getElementById('student-greeting').textContent = `Welcome back, ${user.username}!`;
            // Fetch stats (total chats, helpful feedback, days as member)
            const formData = new FormData();
            formData.append('action', 'getUserProfile');
            formData.append('username', user.username);
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.profile) {
                        document.getElementById('student-avatar').src = data.profile.profilePic || 'default_profile.png';
                        const dateCreated = new Date(data.profile.dateCreated);
                        const days = Math.ceil((Date.now() - dateCreated.getTime()) / (1000*60*60*24));
                        // Fetch helpful feedback count
                        fetchUserHelpfulFeedback(user.username, function(helpfulCount, chatCount) {
                            document.getElementById('student-stats').textContent =
                                `Chats: ${chatCount} | Helpful feedback: ${helpfulCount} | Member for ${days} days`;
                        });
                    }
                });
        }
        function fetchUserHelpfulFeedback(username, cb) {
            const formData = new FormData();
            formData.append('action', 'getFeedback');
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    let helpful = 0, chats = 0;
                    if (data.success && data.feedbacks) {
                        helpful = data.feedbacks.filter(f => f.username === username && f.feedbackType === 'positive').length;
                        chats = data.feedbacks.filter(f => f.username === username).length;
                    }
                    cb(helpful, chats);
                });
        }
        document.addEventListener('DOMContentLoaded', renderStudentWelcome);

        document.getElementById('view-chat-history').addEventListener('click', function() {
            const user = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!user) return;
            const formData = new FormData();
            formData.append('action', 'getUserChatHistory');
            formData.append('username', user.username);
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('chat-history-list');
                    list.innerHTML = '';
                    if (data.success && data.history && data.history.length > 0) {
                        data.history.slice(-10).reverse().forEach(chat => {
                            const div = document.createElement('div');
                            div.style.marginBottom = '1em';
                            div.innerHTML = `<b>Q:</b> ${chat.question}<br><b>A:</b> ${chat.answer}<br><small>${new Date(chat.timestamp).toLocaleString()}</small>`;
                            div.style.cursor = 'pointer';
                            div.onclick = () => {
                                document.getElementById('user-input').value = chat.question;
                                document.getElementById('chat-history-modal').style.display = 'none';
                            };
                            list.appendChild(div);
                        });
                    } else {
                        list.textContent = 'No chat history yet.';
                    }
                    document.getElementById('chat-history-modal').style.display = 'flex';
                });
        });

        let allFAQs = [];
        function fetchAllFAQsForSuggestions() {
            const formData = new FormData();
            formData.append('action', 'getFAQs');
            formData.append('admin', 'true');
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => { if (data.success) allFAQs = data.faqs; });
        }
        document.addEventListener('DOMContentLoaded', fetchAllFAQsForSuggestions);

        document.getElementById('user-input').addEventListener('input', function() {
            const val = this.value.toLowerCase();
            const suggestions = allFAQs.filter(faq => faq.question.toLowerCase().includes(val) && val.length > 2).slice(0,5);
            const container = document.getElementById('faq-suggestions');
            container.innerHTML = '';
            if (suggestions.length > 0) {
                suggestions.forEach(faq => {
                    const div = document.createElement('div');
                    div.textContent = faq.question;
                    div.style.cursor = 'pointer';
                    div.style.background = '#fffbe6';
                    div.style.border = '1px solid #FFD700';
                    div.style.borderRadius = '6px';
                    div.style.padding = '6px 10px';
                    div.style.marginBottom = '4px';
                    div.onclick = () => {
                        document.getElementById('user-input').value = faq.question;
                        container.innerHTML = '';
                    };
                    container.appendChild(div);
                });
            }
        });
    </script>
</body>

</html>

<!-- Team Members:
    Magat Ren Jay S.
    Olaybar, Vlademiere
    Dela Cruz, Eugene Mark
    Kabiling Abegail
    Matic, Britany
    Hazel, Placer
-->